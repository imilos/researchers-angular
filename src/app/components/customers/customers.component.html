<!-- Navigation Bar with Logout Button -->
<nav class="navbar navbar-light bg-light justify-content-between">
  <span class="navbar-brand mb-0 h1">UNIC Researchers Management</span>
  <button class="btn btn-outline-danger" (click)="logout()">Logout</button>
</nav>

<h2 class="text-center mb-4">University of Kragujevac</h2>

<!-- Show the message -->
<div *ngIf="message" [ngClass]="{'alert': true, 'alert-success': !isError, 'alert-danger': isError, 'fade': true, 'show': true}" class="alert-dismissible fade show">
  {{ message }}
</div>

<!-- Form -->
<div class="container mt-4">
  <div class="card border-light shadow-sm">
    <div class="card-header bg-light py-2">
      <h6 class="mb-0">{{ isEditing ? 'Edit Researcher' : 'Add New Researcher' }}</h6>
    </div>
    <div class="card-body p-3">
      <form (ngSubmit)="saveCustomer()" #customerForm="ngForm" novalidate>
        <!-- First Row - Essential Fields -->
        <div class="row g-2 align-items-end">
          <!-- Name -->
          <div class="col-md-2">
            <label class="form-label fw-bold mb-1">Name *</label>
            <input
              type="text"
              [(ngModel)]="customer.name"
              name="name"
              class="form-control"
              placeholder="Name"
              required
              #name="ngModel"
            />
          </div>
          
          <!-- Email -->
          <div class="col-md-2">
            <label class="form-label fw-bold mb-1">Email *</label>
            <input
              type="email"
              [(ngModel)]="customer.email"
              name="email"
              class="form-control"
              placeholder="email@domain.com"
              required
              email
              #email="ngModel"
            />
          </div>
          
          <!-- ORCID -->
          <div class="col-md-2">
            <label class="form-label fw-bold mb-1">ORCID</label>
            <input
              type="text"
              [(ngModel)]="customer.orcid"
              name="orcid"
              class="form-control"
              placeholder="0000-0000-0000-0000"
              pattern="[0-9a-zA-Z]{4}-[0-9a-zA-Z]{4}-[0-9a-zA-Z]{4}-[0-9a-zA-Z]{4}"
              #orcid="ngModel"
            />
          </div>
          
          <!-- Scopus ID -->
          <div class="col-md-2">
            <label class="form-label fw-bold mb-1">Scopus ID</label>
            <input
              type="text"
              [(ngModel)]="customer.scopusid"
              name="scopusid"
              class="form-control"
              placeholder="Scopus ID"
            />
          </div>

          <!-- ECRIS ID -->
          <div class="col-md-3">
            <label class="form-label fw-bold mb-1">ECRIS ID</label>
            <input
              type="text"
              [(ngModel)]="customer.ecrisid"
              name="ecrisid"
              class="form-control"
              placeholder="ECRIS ID"
            />
          </div>
        </div>
        
        <!-- Second Row -->
        <div class="row g-2 align-items-end mt-2 pt-2 border-top">
          <!-- Faculty -->
          <div class="col-md-2">
            <label class="form-label fw-bold mb-1">Faculty</label>
            <select class="form-control" 
                    [(ngModel)]="customer.faculty_id" 
                    (change)="onFacultyChange(customer.faculty_id)" 
                    name="faculty">
              <option *ngFor="let faculty of faculties" [value]="faculty.id">
                {{ getFacultyName(faculty.id) }}
              </option>
            </select>
          </div>
          
          <!-- Department -->
          <div class="col-md-3">
            <label class="form-label fw-bold mb-1">Department</label>
            <select class="form-control" 
                    [(ngModel)]="customer.department_id" 
                    name="department">
              <option [ngValue]="null" selected>Select Department</option>
              <option *ngFor="let department of filteredDepartments" [value]="department.id">
                {{ department.name }}
              </option>
            </select>
          </div>
          
          <!-- Buttons Group -->
          <div class="col-md-3">
            <div class="d-flex gap-2">
              <button
                type="submit"
                class="btn btn-primary flex-grow-1"
                [disabled]="customerForm.invalid"
              >
                {{ isEditing ? 'Update' : 'Add' }}
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary flex-grow-1"
                (click)="resetForm()"
              >
                Reset
              </button>
            </div>
          </div>
          
          <!-- Validation Messages (shown inline) -->
          <div class="col-md-4">
            <div *ngIf="name.invalid && name.touched" class="text-danger">
              <i class="fas fa-exclamation-circle"></i> Name is required
            </div>
            <div *ngIf="email.invalid && email.touched" class="text-danger">
              <i class="fas fa-exclamation-circle"></i> 
              <span *ngIf="email.errors?.['required']">Email is required</span>
              <span *ngIf="email.errors?.['email']">Valid email required</span>
            </div>
            <div *ngIf="orcid.invalid && orcid.touched" class="text-danger">
              <i class="fas fa-exclamation-circle"></i> Invalid ORCID format
            </div>
          </div>
        </div>
        
        <!-- Quick validation hints -->
        <div *ngIf=" (name.invalid || email.invalid) && (name.touched || email.touched)" 
             class="mt-1">
          <small class="text-danger">
            <i class="fas fa-exclamation-triangle"></i> Please fill required fields
          </small>
        </div>
      </form>
    </div>
  </div>
</div>


<div class="container-fluid mt-4 mb-4 ps-0">
  <div class="row g-0">
    <div class="col-md-5"> <div class="form-group d-flex gap-3 align-items-center">
        <input
          type="text"
          id="filterString"
          [(ngModel)]="filterString"
          (input)="this.changePage(1); loadCustomers();"
          class="form-control"
          placeholder="Search name, email, IDs..."
        />
        
        <div class="form-check mb-0 text-nowrap">
          <input 
            class="form-check-input" 
            type="checkbox" 
            id="onlyMultipleAuthorities"
            [(ngModel)]="only_multiple_authorities"
            (change)="this.changePage(1); loadCustomers();"
          >
          <label class="form-check-label" for="onlyMultipleAuthorities">
            Multiple Authorities
          </label>
        </div>

        <button class="btn btn-secondary" (click)="filterString = ''; only_multiple_authorities = false; sortColumn=''; sortDirection=true; loadCustomers()">
          Clear
        </button>
      </div>
    </div>
    <div class="col-md-7 d-flex justify-content-end">
      <button class="btn btn-primary" (click)="downloadCsv()">Download CSV</button>
    </div>
  </div>
</div>

<!-- Customer List Table -->
<table class="table table-striped mt-4">
  <thead>
    <tr>
      <th scope="col" (click)="sortTable('name')">
        Name
        <span class="sort-icon" *ngIf="sortColumn === 'name'">
          {{ sortDirection ? '↑' : '↓' }}
        </span>
      </th>
      <th scope="col" (click)="sortTable('email')">
        Email
        <span class="sort-icon" *ngIf="sortColumn === 'email'">
          {{ sortDirection ? '↑' : '↓' }}
        </span>
      </th>
      <th scope="col" (click)="sortTable('orcid')">
        ORCID
        <span class="sort-icon" *ngIf="sortColumn === 'orcid'">
          {{ sortDirection ? '↑' : '↓' }}
        </span>
      </th>
      <th scope="col" (click)="sortTable('scopusid')">
        Scopus ID
        <span class="sort-icon" *ngIf="sortColumn === 'scopusid'">
          {{ sortDirection ? '↑' : '↓' }}
        </span>
      </th>
      <th scope="col" (click)="sortTable('ecrisid')">
        ECRIS ID
        <span class="sort-icon" *ngIf="sortColumn === 'ecrisid'">
          {{ sortDirection ? '↑' : '↓' }}
        </span>
      </th>
      <th scope="col" (click)="sortTable('faculty')">
        Faculty
        <span class="sort-icon" *ngIf="sortColumn === 'faculty'">
          {{ sortDirection ? '↑' : '↓' }}
        </span>
      </th>
      <th scope="col" (click)="sortTable('department')">
        Department
        <span class="sort-icon" *ngIf="sortColumn === 'department'">
          {{ sortDirection ? '↑' : '↓' }}
        </span>
      </th>
      <th scope="col">SCIDAR Authorities </th>
      <th scope="col" class="text-end">Actions</th>
    </tr>
  </thead>  
  <tbody>
    <tr *ngFor="let cust of customers; let i = index">
      <!-- <td>{{ cust.id }}</td> -->
      <td><a href="{{ unikgurl }}{{ cust.ecrisid }}" target="_blank">{{ cust.name }}</a></td>
      <td>{{ cust.email }}</td>
      <td><a href="{{ orcidurl }}{{ cust.orcid }}" target="_blank">{{ cust.orcid }}</a></td>
      <td><a href="{{ scopusurl }}{{ cust.scopusid }}" target="_blank">{{ cust.scopusid }}</a></td>
      <td><a href="{{ ecrisurl }}{{ formatEcrisId(cust.ecrisid) }}" target="_blank">{{ cust.ecrisid }}</a></td>
      <td>{{ getFacultyName(cust.faculty_id) }}</td>
      <td>{{ getDepartmentName(cust.department_id) }}</td>
      <td [innerHTML]="formatAuthorities(cust.authorities)"></td>
      <td class="text-end">
        <button
          class="btn btn-sm btn-warning me-2"
          (click)="editCustomer(cust)"
        >
          Edit
        </button>

        <button
          class="btn btn-sm btn-danger"
          (click)="openDeleteModal(cust.id)"
          data-bs-toggle="modal"
          data-bs-target="#deleteConfirmationModal"
        >
        Delete
        </button>                
      </td>
    </tr>
  </tbody>
</table>

<!-- Pagination Controls -->
<div class="d-flex justify-content-between align-items-center mt-4">
  <div>
    <label for="pageSize" class="me-2">Items per page:</label>
    <select id="pageSize" [(ngModel)]="pageSize" (change)="changePage(1); loadCustomers();" class="form-select d-inline-block w-auto">
      <option value="5">5</option>
      <option value="10">10</option>
      <option value="20">20</option>
      <option value="50">50</option>
      <option value="100">100</option>
    </select>
  </div>
  <ul class="pagination mb-0">
    <li class="page-item" [class.disabled]="currentPage === 1">
      <button class="page-link" (click)="changePage(1)">&laquo;</button>
    </li>
    <li class="page-item" [class.disabled]="currentPage === 1">
      <button class="page-link" (click)="changePage(currentPage - 1)">&lt;</button>
    </li>
    <li class="page-item disabled">
      <span class="page-link">Page {{ currentPage }} of {{ totalPages }}</span>
    </li>
    <li class="page-item" [class.disabled]="currentPage === totalPages">
      <button class="page-link" (click)="changePage(currentPage + 1)">&gt;</button>
    </li>
    <li class="page-item" [class.disabled]="currentPage === totalPages">
      <button class="page-link" (click)="changePage(totalPages)">&raquo;</button>
    </li>
  </ul>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmationLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete customer {{deleteCustomerName}}?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal" (click)="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>
</div>
